<!DOCTYPE html>
<html>
<head>
    <title>Complete Owner Login Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
        button { padding: 12px 24px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .login-form { background: #e9ecef; padding: 20px; border-radius: 5px; margin: 10px 0; }
        input { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; width: 200px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöå NxtBus Owner Login - Complete Test</h1>
        <p>This test simulates the exact login flow used by the Owner App</p>
        
        <div class="test-section">
            <h3>üîß Configuration</h3>
            <div id="config-info"></div>
        </div>
        
        <div class="test-section">
            <h3>üè• Server Health</h3>
            <button onclick="checkServerHealth()">Check Server Health</button>
            <div id="health-status"></div>
        </div>
        
        <div class="test-section">
            <h3>üîê Owner Login Test</h3>
            <div class="login-form">
                <div>
                    <label>Phone Number:</label><br>
                    <input type="tel" id="phone" value="9876500001" maxlength="10">
                </div>
                <div>
                    <label>PIN:</label><br>
                    <input type="password" id="pin" value="1234" maxlength="4">
                </div>
                <div>
                    <button onclick="testOwnerLogin()">üîê Login</button>
                    <button onclick="clearSession()">üóëÔ∏è Clear Session</button>
                </div>
            </div>
            <div id="login-status"></div>
        </div>
        
        <div class="test-section">
            <h3>üìû Call Alerts Test</h3>
            <button onclick="testCallAlerts()">Test Call Alerts API</button>
            <div id="alerts-status"></div>
        </div>
        
        <div class="test-section">
            <h3>üöå Owner Buses Test</h3>
            <button onclick="testOwnerBuses()">Test Owner Buses</button>
            <div id="buses-status"></div>
        </div>
        
        <div class="test-section">
            <h3>üíæ Session Management</h3>
            <button onclick="checkSession()">Check Current Session</button>
            <div id="session-status"></div>
        </div>
    </div>

    <script>
        // Exact same configuration as owner app
        const getHost = () => {
            if (window.Capacitor?.isNativePlatform()) {
                return '10.77.155.222';
            }
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                return window.location.hostname;
            }
            return 'localhost';
        };

        const HOST = getHost();
        const API_BASE = `http://${HOST}:3001/api`;
        
        // Same keys as owner app
        const OWNER_KEY = 'nxtbus_current_owner';
        const OWNER_SESSION_KEY = 'nxtbus_owner_session';

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<div class="status ${statusClass}">${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearStatus(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Initialize configuration display
        function showConfig() {
            const configDiv = document.getElementById('config-info');
            configDiv.innerHTML = `
                <div class="info">üåê API Base URL: <strong>${API_BASE}</strong></div>
                <div class="info">üñ•Ô∏è Detected Host: <strong>${HOST}</strong></div>
                <div class="info">üìç Window Location: <strong>${window.location.hostname}</strong></div>
                <div class="info">üì± Is Capacitor: <strong>${!!window.Capacitor?.isNativePlatform()}</strong></div>
                <div class="info">üîó Current Origin: <strong>${window.location.origin}</strong></div>
            `;
        }

        async function checkServerHealth() {
            clearStatus('health-status');
            updateStatus('health-status', 'üîç Checking server health...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('health-status', '‚úÖ Server is healthy and responding!', 'success');
                    updateStatus('health-status', `üìä Server: ${data.server}`, 'info');
                    updateStatus('health-status', `üåç Environment: ${data.environment}`, 'info');
                } else {
                    updateStatus('health-status', `‚ùå Server health check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                updateStatus('health-status', `‚ùå Cannot connect to server: ${error.message}`, 'error');
                updateStatus('health-status', 'üí° Make sure the server is running on port 3001', 'warning');
            }
        }

        async function testOwnerLogin() {
            clearStatus('login-status');
            
            const phone = document.getElementById('phone').value;
            const pin = document.getElementById('pin').value;
            
            if (!phone || !pin) {
                updateStatus('login-status', '‚ùå Please enter both phone and PIN', 'error');
                return;
            }
            
            updateStatus('login-status', `üîê Attempting login for phone: ${phone}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/owner/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, pin })
                });
                
                updateStatus('login-status', `üì° Response Status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    updateStatus('login-status', `‚ùå HTTP Error: ${response.status} - ${errorText}`, 'error');
                    
                    if (response.status === 0 || errorText.includes('CORS')) {
                        updateStatus('login-status', 'üö´ CORS Error: Port 5174 may not be allowed', 'error');
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('login-status', '‚úÖ Login successful!', 'success');
                    updateStatus('login-status', `üë§ Welcome: ${data.owner.name}`, 'success');
                    updateStatus('login-status', `üè¢ Owner ID: ${data.owner.id}`, 'info');
                    updateStatus('login-status', `üìß Email: ${data.owner.email}`, 'info');
                    updateStatus('login-status', `üìç Address: ${data.owner.address}`, 'info');
                    
                    // Save session exactly like the owner app
                    localStorage.setItem(OWNER_KEY, JSON.stringify(data.owner));
                    localStorage.setItem(OWNER_SESSION_KEY, JSON.stringify({
                        timestamp: Date.now(),
                        ownerId: data.owner.id
                    }));
                    
                    updateStatus('login-status', 'üíæ Session saved to localStorage', 'success');
                    
                    // Show token info if available
                    if (data.token) {
                        updateStatus('login-status', 'üé´ JWT Token received', 'success');
                    }
                } else {
                    updateStatus('login-status', `‚ùå Login failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                updateStatus('login-status', `‚ùå Login error: ${error.message}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    updateStatus('login-status', 'üåê Network error: Cannot reach server', 'error');
                } else if (error.message.includes('CORS')) {
                    updateStatus('login-status', 'üö´ CORS policy error', 'error');
                }
            }
        }

        async function testCallAlerts() {
            clearStatus('alerts-status');
            updateStatus('alerts-status', 'üìû Testing call alerts API...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/callAlerts`);
                
                if (!response.ok) {
                    updateStatus('alerts-status', `‚ùå Call alerts API failed: ${response.status}`, 'error');
                    return;
                }
                
                const alerts = await response.json();
                updateStatus('alerts-status', `‚úÖ Call alerts loaded successfully`, 'success');
                updateStatus('alerts-status', `üìä Total alerts: ${alerts.length}`, 'info');
                
                if (alerts.length > 0) {
                    const ownerAlerts = alerts.filter(a => a.ownerId === 'OWN001');
                    updateStatus('alerts-status', `üè¢ Alerts for OWN001: ${ownerAlerts.length}`, 'info');
                    
                    if (ownerAlerts.length > 0) {
                        const alert = ownerAlerts[0];
                        updateStatus('alerts-status', `üìû Sample Alert: ${alert.driverName} - ${alert.callStatus}`, 'info');
                    }
                }
            } catch (error) {
                updateStatus('alerts-status', `‚ùå Call alerts error: ${error.message}`, 'error');
            }
        }

        async function testOwnerBuses() {
            clearStatus('buses-status');
            updateStatus('buses-status', 'üöå Testing buses API...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/buses`);
                
                if (!response.ok) {
                    updateStatus('buses-status', `‚ùå Buses API failed: ${response.status}`, 'error');
                    return;
                }
                
                const buses = await response.json();
                updateStatus('buses-status', `‚úÖ Buses loaded successfully`, 'success');
                updateStatus('buses-status', `üìä Total buses: ${buses.length}`, 'info');
                
                // Filter for current owner (OWN001)
                const ownerBuses = buses.filter(b => b.ownerId === 'OWN001');
                updateStatus('buses-status', `üè¢ Buses for OWN001: ${ownerBuses.length}`, 'success');
                
                if (ownerBuses.length > 0) {
                    ownerBuses.forEach(bus => {
                        updateStatus('buses-status', `üöå Bus ${bus.number} (${bus.type}) - ${bus.status}`, 'info');
                    });
                }
            } catch (error) {
                updateStatus('buses-status', `‚ùå Buses error: ${error.message}`, 'error');
            }
        }

        function checkSession() {
            clearStatus('session-status');
            
            const storedOwner = localStorage.getItem(OWNER_KEY);
            const storedSession = localStorage.getItem(OWNER_SESSION_KEY);
            
            if (!storedOwner || !storedSession) {
                updateStatus('session-status', '‚ùå No active session found', 'error');
                return;
            }
            
            try {
                const owner = JSON.parse(storedOwner);
                const session = JSON.parse(storedSession);
                
                const sessionAge = Date.now() - session.timestamp;
                const sessionHours = Math.floor(sessionAge / (1000 * 60 * 60));
                const sessionMinutes = Math.floor((sessionAge % (1000 * 60 * 60)) / (1000 * 60));
                
                updateStatus('session-status', '‚úÖ Active session found', 'success');
                updateStatus('session-status', `üë§ Owner: ${owner.name} (${owner.id})`, 'info');
                updateStatus('session-status', `‚è∞ Session age: ${sessionHours}h ${sessionMinutes}m`, 'info');
                
                // Check if session is still valid (24 hours)
                if (sessionAge < 24 * 60 * 60 * 1000) {
                    updateStatus('session-status', '‚úÖ Session is still valid', 'success');
                } else {
                    updateStatus('session-status', '‚ö†Ô∏è Session has expired', 'warning');
                }
            } catch (error) {
                updateStatus('session-status', `‚ùå Session data corrupted: ${error.message}`, 'error');
            }
        }

        function clearSession() {
            localStorage.removeItem(OWNER_KEY);
            localStorage.removeItem(OWNER_SESSION_KEY);
            updateStatus('login-status', 'üóëÔ∏è Session cleared', 'info');
        }

        // Initialize on page load
        window.onload = function() {
            showConfig();
            checkServerHealth();
            checkSession();
        };
    </script>
</body>
</html>